# Database – Adapter × Dynamic Query × Repository

Let me guess, this is probably the most provocative pattern in `Chimera`.  
Because the moment you say `Dynamic Query`, every senior in the room hears.    

    Hi, I’m John. Please hack me!

But since **our core mission is to reduce boilerplate and stay flexible**, ``Dynamic Query`` is necessary.

**You may ask me, why not `Entity Framework`?**  
→ *Because it makes my build time longer than my patience.*   
**You may also ask, why don't use dapper?**  
→  *Not just use, I abuse it*.

So at this point we gonna move on with these dangerous assumsion: 
1. **In modern technology any "robust" database you can found have at least one good database connector and one query builder.** 
    - **This setence can be wrong*
2. **We chose the most light one (which give us more power and perfomance) and heavily abuse it**. 
    - **If (1) is wrong, this part becomes pointless.*
3. **`Infra` talks to the `library`, `library` talks to the `Adapter`, `Repository` performs validation to ensure everyone survives.**. 
    - **If (1) is wrong, this also becomes pointless*

## **Note**
I want to write a full guide for multiple types of databases, but that would take more effort than the entire `Chimera Architecture` itself, so I’ll save that for later.

Within `Chimera`, I will **focus only on `SQL` and `Dapper`**.
Since most **applications handle databases in roughly the same way**, you might still find this spec helpful. ( **I guess.* )

## **Adapter × Dynamic Query**

Most heavy Dapper projects skip the adapter layer entirely.  
You often see a giant repository with hand-written CRUD SQL, full strings, tons of boilerplate, and a dev silently crying with IDE auto-complete (****me***).

**But the truth is:**
you don’t need that much SQL for 90% of business use cases.

What you really need is:

- Four simple CRUD functions (single-row operations)
- One bulk-insert function
- One `select-where` that returns multiple rows
- One raw-query entry point for stored procedures

This is enough to build almost every common workflow without drowning in SQL strings.

By placing **Dynamic Query** inside an **Adapter** and validating everything in the **Repository**,  
we keep the flexibility of Dapper while reducing boilerplate and controlling the trade-off.


## **Query deep dive**  
A dinamic qury basically look like this 

``` SQL
Action (CRUD) + [columns] + From [table] + WHERE [columns] + ORDER / PAGING / LIMIT
```
which convert to C# look like 
``` csharp
string input_action = ";drop database; select ";
string input_columns = ";drop again; a, b, c ";
string input_table = ";drop again; table_name ";
string input_where = $";drop again; a = {1} ";

string SQL = $"{input_action} {input_columns} FROM {input_table} WHERE {input_where} ORDER BY 1;";

// execute (SQL)
```
**This approach is:**  
- Quick!
- Straightforward!
- **And drops your database four times without returning anything.**

**The source of all evil is that, the normal `Dynamic SQL` let user input their query with `string`.**  

## **Chimera approach**
- **Each query has both static and dynamic components** depending on its nature.

- `The Adapter` **defines the static components** such as the base query skeleton.

- `The Repository` provides table information (**it should know exactly what table being use by current Use Cases**) and fills the condition block **using parameterized queries** only.

- If a new feature is required, **the Repository creates only that feature**, no need to build a full SQL suite upfront.

- `ValueObject` / `DataObject` define which columns **belong to the first block** (SELECT / UPDATE block).

- `Raw queries` are **allowed only for predefined stored procedures**, and **those procedures must also use parameterized queries**, especially when they contain dynamic SQL internally.

- **At this point, since the Adapter only receives pre-defined objects from upper layers, there should be no attack vector for SQL injection.**. But if you still worry, Dapper does have a library you should absolutely abuse: [InterpolatedSql](https://github.com/Drizin/InterpolatedSql).

****I stuggled to do sql injection with this one myself, if you can do it, I wanna lean from you!***
